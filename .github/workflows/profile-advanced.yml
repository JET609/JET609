name: "ü§† Advanced Profile Automations"

on:
  schedule:
    # Runs every day at 18:15 IST (12:45 UTC)
    - cron: "45 12 * * *"
  workflow_dispatch: {}

jobs:
  update-profile:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Update dynamic sections
        run: |
          python - << 'PY'
          import re
          import json
          import datetime
          import random
          import pathlib
          import urllib.request
          import xml.etree.ElementTree as ET

          README_PATH = pathlib.Path("README.md")
          readme_content = README_PATH.read_text(encoding="utf-8")

          # ---------- Helpers ----------
          def replace_block(block_tag, new_content, source_text):
              pattern = rf"<!--{block_tag}_START-->(.*?)<!--{block_tag}_END-->"
              replacement = f"<!--{block_tag}_START-->{new_content}<!--{block_tag}_END-->"
              return re.sub(pattern, replacement, source_text, flags=re.DOTALL)

          def update_last_updated_and_quote(source_text):
              # IST time
              indian_standard_time = datetime.datetime.utcnow() + datetime.timedelta(hours=5, minutes=30)
              last_updated = indian_standard_time.strftime("%Y-%m-%d %H:%M IST")

              quotes = [
                  "Discipline compounds. Tiny steps, big outcomes.",
                  "Code. Ship. Learn. Repeat.",
                  "Consistency beats motivation.",
                  "Build things that outlive the tutorial.",
                  "Your GitHub is your portfolio. Treat it like one.",
                  "Small progress daily becomes an unfair advantage.",
              ]
              selected_quote = random.choice(quotes)

              def replace_tag_content(tag_name, value, text):
                  pattern = rf"<!--{tag_name}-->(.*?)<!--/{tag_name}-->"
                  new_content = f"<!--{tag_name}-->{value}<!--/{tag_name}-->"
                  return re.sub(pattern, new_content, text, flags=re.DOTALL)

              source_text = replace_tag_content("LAST_UPDATED", last_updated, source_text)
              source_text = replace_tag_content("RANDOM_QUOTE", selected_quote, source_text)
              return source_text

          def fetch_medium_posts_feed(feed_url, max_posts=3):
              try:
                  with urllib.request.urlopen(feed_url, timeout=10) as response:
                      feed_data = response.read()
                  xml_root = ET.fromstring(feed_data)
                  rss_channel = xml_root.find("channel")
                  if rss_channel is None:
                      return []
                  feed_items = rss_channel.findall("item")[:max_posts]
                  blog_posts = []
                  for item in feed_items:
                      title = (item.findtext("title") or "").strip()
                      link = (item.findtext("link") or "").strip()
                      if title and link:
                          blog_posts.append((title, link))
                  return blog_posts
              except Exception as error:
                  print("Medium fetch error:", error)
                  return []

          def build_blog_markdown(blog_posts):
              if not blog_posts:
                  return "\nLoading latest posts...\n"
              markdown_lines = ["\n"]
              for title, link in blog_posts:
                  markdown_lines.append(f"- [{title}]({link})")
              markdown_lines.append("\n")
              return "\n".join(markdown_lines)

          def fetch_top_repos(github_username, max_repos=4):
              try:
                  api_url = f"https://api.github.com/users/{github_username}/repos?per_page=100&sort=updated"
                  with urllib.request.urlopen(api_url, timeout=10) as response:
                      repositories = json.load(response)
              except Exception as error:
                  print("GitHub API error:", error)
                  return []

              # filter out profile repo and junk if needed
              repos_to_ignore = {github_username, f"{github_username}.github.io", "JET609"}
              filtered_repos = [
                  repo for repo in repositories
                  if not repo.get("fork")
                  and repo.get("name") not in repos_to_ignore
                  and not repo.get("name", "").lower().startswith("test")
              ]

              # sort by stargazers + recent activity
              filtered_repos.sort(key=lambda repo: (repo.get("stargazers_count", 0), repo.get("pushed_at") or ""), reverse=True)
              return filtered_repos[:max_repos]

          def build_projects_markdown(repositories):
              if not repositories:
                  return "\nHighlighting key projects soon...\n"
              markdown_lines = ["\n"]
              for repo in repositories:
                  repo_name = repo["name"]
                  repo_full_name = repo["full_name"]
                  description = (repo.get("description") or "No description yet.").strip()
                  star_count = repo.get("stargazers_count", 0)
                  language = repo.get("language") or "Tech"
                  repo_url = repo.get("html_url")
                  markdown_lines.append(
                      f"- [{repo_name}]({repo_url}) ‚Äî {description} "
                      f"¬∑ ‚≠ê {star_count} ¬∑ *{language}*"
                  )
              markdown_lines.append("\n")
              return "\n".join(markdown_lines)

          # ---------- Apply updates ----------
          updated_readme = readme_content

          # 1) Last updated + random quote
          updated_readme = update_last_updated_and_quote(updated_readme)

          # 2) Blog posts from Medium
          blog_posts = fetch_medium_posts_feed("https://medium.com/feed/@jayanththomas2004")
          blog_posts_markdown = build_blog_markdown(blog_posts)
          updated_readme = replace_block("BLOG", blog_posts_markdown, updated_readme)

          # 3) Auto top projects from GitHub
          github_repos = fetch_top_repos("JET609")
          projects_markdown = build_projects_markdown(github_repos)
          updated_readme = replace_block("PROJECTS", projects_markdown, updated_readme)

          if updated_readme != readme_content:
              README_PATH.write_text(updated_readme, encoding="utf-8")
              print("README updated.")
          else:
              print("No changes made.")
          PY

      - name: Commit & push if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "chore: üß† auto-update profile sections" || exit 0
            git push
          else
            echo "No changes to commit."
          fi
